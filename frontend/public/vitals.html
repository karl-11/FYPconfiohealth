<!DOCTYPE html>
<html lang="en">

<head>
    <title>Home</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Bootstrap-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!--Custom CSS-->
    <link rel="stylesheet" type="text/css" href="./css/Custom.css">
    <link rel="stylesheet" type="text/css" href="./css/Vitals.css">

    <!--Font import-->
    <link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet'>

    <!--JQuery-->
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
    <!--Axios-->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!--Google Chart-->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>


    <!--Include Header & Footer-->
    <script>
        $(function () {
            $("#header").load("header.html");
            $("#footer").load("footer.html");
        });
    </script>

</head>

<body class="font-montserrat body">
    <!--Header section-->

    <section class="w-75 min-vh-100 mx-auto pb-170px">
        <span id="header"></span>

        <div class="scrollmenu hidescroll" id="vitalnav" onchange="loadchart(),displayRadioValue()">

        </div>

        <div id="chart_div">

        </div>

        <div id="valuebtn">

        </div>


        <div id="overlay" onclick="off()">

        </div>

        <div id="overlaycontent" class="bg-beige" onchange="displayCheckValue()">
            <div>
                <div>
                    <div class="container">
                        <h3>Selected</h3>
                        <div id="selected" class="row" onchange="removeSelectedVital()">

                        </div>

                        <h3>Not Selected</h3>
                        <div id="notselected" class="row" onchange="addSelectedVital()">

                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--Footer section-->
        <span id="footer"></span>
    </section>

    <!--bootstrap bundle script-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Get vitals from table and put into html
        const baseUrl = "http://localhost:3000";

        // Data extraction from localstorage
        const loggedinid = localStorage.getItem('loggedInUserID');

        // data compilation
        var requestBody = {
            userid: loggedinid
        };
        // console.log("---------------- compiled data -----------");
        // console.log(requestBody);

        window.addEventListener('DOMContentLoaded', selectedvitals());
        window.addEventListener('DOMContentLoaded', notSelectedVitals());

        function selectedvitals() {
            axios.post(`${baseUrl}/selectedvitals`, requestBody)
                .then((response) => {

                    var vitalsStringSelected = "";
                    var vitalsStringNav = "";
                    // overlay button to add to end of nav
                    var overlayButtonString =
                        `
                        <div class="form-check form-check-inline">
                            <button type="button" class="btn flex-column card border-0 p-2 text-center" onclick="on()">
                            <img src="images/icons8-plus.png" alt="">
                            </button>
                        </div>
                        `;

                    //console.log(response.data);

                    for (i = 0; i < response.data.length; i++) {

                        //console.log("select vitals");
                        var data = response.data[i];
                        //console.log(data);

                        var vitalsStringSelected = vitalsStringSelected +
                            `
                            <div class="form-check col-lg-3 col-md-4 m-0 p-0">
                                <input class="form-check-input" type="checkbox" value="${data.vitalsid}" name="vitalscheck" id="${data.selectedVitals.toLowerCase()}">
                                <label class="form-check-label text-center" for="${data.selectedVitals.toLowerCase()}">
                                     <img src="${data.vital_sign_img}" class="align-self-center" alt="">
                                     <p>
                                      ${data.selectedVitals}
                                     </p>
                                </label>
                            </div>
                     `

                        var vitalsStringNav = vitalsStringNav +
                            `
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="vitalsradio" id="${data.selectedVitals.toLowerCase() + "selected"}" value="${data.vitalsid}">
                                <label class="form-check-label card border-0 p-2 text-center" for="${data.selectedVitals.toLowerCase() + "selected"}">
                                    <img src="${data.vital_sign_img}" class="align-self-center" alt="">
                                    ${data.selectedVitals}                            
                                </label>
                            </div>
                            `
                    }
                    document.getElementById("selected").innerHTML = vitalsStringSelected;
                    document.getElementById("vitalnav").innerHTML = vitalsStringNav + overlayButtonString;
                    // Hide check Button
                    for (let i = 0; i < vitalscheck.length; i++) {
                        vitalscheck[i].style.display = "none";
                    }
                    // Hide Radio Button
                    for (let i = 0; i < vitalsradio.length; i++) {
                        vitalsradio[i].style.display = "none";
                    }
                    // Add border and background to Selected Radio
                    $(document).ready(function () {
                        $('.form-check-inline>label').click(function () {
                            $('label').removeClass(' shadow-bottom bg-cards border rounded-4');
                            $(this).addClass(' shadow-bottom bg-cards border rounded-4');
                        });
                    });

                })
                .catch((error) => {
                    console.log(error);
                });

        }

        function notSelectedVitals() {
            axios.post(`${baseUrl}/notSelectedVitals`, requestBody)
                .then((response) => {

                    var vitalsStringNotSelected = "";

                    for (i = 0; i < response.data.length; i++) {

                        //console.log("Not selected vitals");
                        var data = response.data[i];
                        //console.log(data);

                        var vitalsStringNotSelected = vitalsStringNotSelected +
                            `
                                <div class="form-check col-lg-3 col-md-4 m-0 p-0">
                                    <input class="form-check-input" type="checkbox" value="${data.id}" name="vitalscheck" id="${data.vital_sign_type.toLowerCase()}">
                                        <label class="form-check-label text-center" for="${data.vital_sign_type.toLowerCase()}">
                                            <img src="${data.vital_sign_img}" class="align-self-center" alt="">
                                            <p>
                                             ${data.vital_sign_type}
                                            </p>
                                        </label>
                                </div>
                                `
                    }
                    document.getElementById("notselected").innerHTML = vitalsStringNotSelected;

                    // Hide check Button
                    for (let i = 0; i < vitalscheck.length; i++) {
                        vitalscheck[i].style.display = "none";
                    }
                })
                .catch((error) => {
                    console.log(error);
                });

        }

        //console.log(vitals);
        var vitalsradio = document.getElementsByName("vitalsradio");
        var vitalscheck = document.getElementsByName("vitalscheck");

        console.log(vitalsradio);
        console.log(vitalscheck);

        // too see the value of selected radio
        function displayRadioValue() {
            console.log(vitalsradio)
            for (i = 0; i < vitalsradio.length; i++) {
                if (vitalsradio[i].checked) {
                    console.log("id: " + vitalsradio[i].value);
                    console.log("Vital: " + vitalsradio[i].id.replace("selected", ""));
                }
            }
        };

        function displayCheckValue() {
            console.log(vitalscheck)
            for (i = 0; i < vitalscheck.length; i++) {
                if (vitalscheck[i].checked) {
                    console.log("id: " + vitalscheck[i].id)
                    console.log("value: " + vitalscheck[i].value)
                }
            }
        };

        function addSelectedVital() {

            for (i = 0; i < vitalscheck.length; i++) {
                if (vitalscheck[i].checked) {
                    var requestBody = {
                        userid: loggedinid,
                        vitalid: vitalscheck[i].value
                    };
                }
            }
            //console.log(requestBody);

            axios.post(`${baseUrl}/addSelectedVitals`, requestBody)
                .then((response) => {

                    //console.log("add selected vital");
                    var data = response.data.affectedRows;
                    console.log(data);
                    selectedvitals();
                    notSelectedVitals();
                })
                .catch((error) => {
                    console.log(error);
                });



        };

        function removeSelectedVital() {

            for (i = 0; i < vitalscheck.length; i++) {
                if (vitalscheck[i].checked) {
                    var requestBody = {
                        userid: loggedinid,
                        vitalid: vitalscheck[i].value
                    };
                }
            }
            //console.log(requestBody);

            axios.post(`${baseUrl}/removeSelectedVitals`, requestBody)
                .then((response) => {
                    // console.log("Remove selected vitals");
                    var data = response.data.affectedRows;
                    // console.log("rows affected: " + data);
                    selectedvitals();
                    notSelectedVitals();
                })
                .catch((error) => {
                    console.log(error);
                });



        };

        // Make Vitals scrollable by dragging
        const slider = document.querySelector('.scrollmenu');
        let mouseDown = false;
        let startX, scrollLeft;

        let startDragging = function (e) {
            mouseDown = true;
            startX = e.pageX - slider.offsetLeft;
            scrollLeft = slider.scrollLeft;
        };
        let stopDragging = function (event) {
            mouseDown = false;
        };

        slider.addEventListener('mousemove', (e) => {
            e.preventDefault();
            if (!mouseDown) { return; }
            const x = e.pageX - slider.offsetLeft;
            const scroll = x - startX;
            slider.scrollLeft = scrollLeft - scroll;
        });

        // Add the event listeners
        slider.addEventListener('mousedown', startDragging, false);
        slider.addEventListener('mouseup', stopDragging, false);
        slider.addEventListener('mouseleave', stopDragging, false);

        // Overlay On
        function on() {
            document.getElementById("overlay").style.width = "100%";
            document.getElementById("overlaycontent").style.width = "50%";
        }
        // Overlay Off
        function off() {
            document.getElementById("overlay").style.width = "0%";
            document.getElementById("overlaycontent").style.width = "0%";
        };



        function loadchart() {
            for (i = 0; i < vitalsradio.length; i++) {
                if (vitalsradio[i].checked) {
                    var requestBody = {
                        userid: loggedinid,
                        vitalid: vitalsradio[i].value
                    };
                    console.log(requestBody);
                }
            }
            axios.post(`${baseUrl}/getVitalValue`, requestBody)
                .then((response) => {
                    console.log("get vitals value");
                    var res = response.data;
                    console.log(res);
                    var number = res[0].vital_value
                    console.log("-----------number-----------");
                    console.log(number);
                    console.log("load chart");

                    //Google Chart
                    google.charts.load('current', { packages: ['corechart', 'line'] });

                    google.charts.setOnLoadCallback(drawBackgroundColor);

                    function drawBackgroundColor() {
                        var data = new google.visualization.DataTable();
                        data.addColumn('datetime', 'date/time');
                        data.addColumn('number', number);

                        var test = []

                        if (res.length != 0) {
                            for (i = 0; i < res.length; i++) {

                                // Split timestamp into [ Y, M, D, h, m, s ]
                                var t = res[i].datetimecreated.split(/[- : T Z]/);

                                // Apply each element to the Date function
                                var d = new Date(Date.UTC(t[0], t[1] - 1, t[2], t[3], t[4]));
                                test.push([d, res[i].vitalvalue])
                                console.log(t);
                                console.log(d);
                                console.log(res[i]);
                            }

                        }
                        else {
                            var d = new Date
                            test.push([d, 0])
                        }

                        console.log(test);

                        data.addRows(
                            test
                        );

                        var options = {
                            hAxis: {
                                title: 'date',
                                gridlines: {
                                    count: -1,
                                    units: {
                                        days: { format: ['MMM dd'] },
                                        hours: { format: ['HH:mm', 'ha'] },
                                    }
                                },
                            },
                            vAxis: {
                                title: number,
                            },
                            backgroundColor: '#ffffff',
                            legend: 'none',
                            pointSize: 10,
                            height: 400
                        };
                        var valuebtn = 
                        `
                        <div class="text-center fixed-bottom " style="bottom: 25%;">
                            <button type="button" class="btn bg-beige ">
                                <a class= "text-decoration-none text-dark" href="http://localhost:3001/vitals.html">Add Value</a>
                            </button>
                        </div>
                        `
                        document.getElementById("valuebtn").innerHTML = valuebtn;

                        var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
                        chart.draw(data, options);
                    }

                })
                .catch((error) => {
                    console.log(error);
                });

        }
    </script>

</body>


</html>